{% extends "challenge.html" %}
{% load url %}
{% load profiles %}

{% block breadcrumbs %}
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a
                href="{% url 'challenges:list' %}">Challenges</a>
        </li>
        <li class="breadcrumb-item"><a
                href="{{ challenge.get_absolute_url }}">{% firstof challenge.title challenge.short_name %}</a></li>
        <li class="breadcrumb-item active" aria-current="page">Submissions</li>
    </ol>
{% endblock %}

{% block sidebar %}
    <div class="nav nav-pills d-none {% if challenge.phase_set.count > 4 %}d-lg-inline-flex{% elif challenge.phase_set.count == 4 %}d-md-inline-flex{% else %}d-sm-inline-flex{% endif %} col-12 pl-3 mb-3">
        {% if "change_challenge" in challenge_perms or user_is_participant %}
            {% for phase in challenge.phase_set.all %}
                <li class="nav-item">
                    <a class="nav-link mr-1 px-4 py-1 {% if request.resolver_match.view_name == 'evaluation:submission-create' and request.resolver_match.kwargs.slug == phase.slug or request.resolver_match.view_name == 'evaluation:submission-create-legacy' and request.resolver_match.kwargs.slug == phase.slug%}active{% endif %}"
                       href="{% url 'evaluation:submission-create' challenge_short_name=challenge.short_name slug=phase.slug %}">{{ phase.title }}</a>
                </li>
            {% endfor %}
            <li>
                <a class="nav-link mr-1 px-4 py-1 {% if request.resolver_match.view_name == 'evaluation:submission-list' %}active{% endif %}"
                    href="{% url 'evaluation:submission-list' challenge_short_name=challenge.short_name %}">Your Submissions
                </a>
            </li>
        {% endif %}
    </div>
    <div class="nav nav-pills d-flex {% if challenge.phase_set.count > 4 %}d-lg-none{% elif challenge.phase_set.count == 4 %}d-md-none{% else %}d-sm-none{% endif %} col-12 pl-3 mb-3">
        {% if "change_challenge" in challenge_perms or user_is_participant %}
            <div class="btn dropdown border-0 px-0 py-0 mb-1">
                <a class="btn btn-outline-dark dropdown-toggle phaseButton mr-1 px-4"
                   data-toggle="dropdown"
                   href="#"
                   role="button"
                   aria-expanded="false">
                    Choose a Phase</a>
                <div class="dropdown-menu dropdown-menu-left" role="menu">
                    {% for phase in challenge.phase_set.all %}
                        <li class="dropdown-item challengeDropdown px-0">
                            <a class="nav-link mr-1 px-4 py-1"
                           href="{% url 'evaluation:submission-create' challenge_short_name=challenge.short_name slug=phase.slug %}"
                            style="color: black">{{ phase.title }}</a>
                        </li>
                    {% endfor %}
                </div>
            </div>
            <li>
                <a class="nav-link mr-1 px-4 py-1 {% if request.resolver_match.view_name == 'evaluation:submission-list' %}active{% endif %}"
                   href="{% url 'evaluation:submission-list' challenge_short_name=challenge.short_name %}">Your Submissions
                </a>
            </li>
        {% endif %}
    </div>
{% endblock %}

{% block content %}

    <h2>Submissions</h2>

    <div class="table-responsive">
        <table class="table table-hover table-borderless table-sm" id="submissionsTable">
            <thead class="thead-light">
            <tr>
                <th>Created</th>
                <th>Phase</th>
                <th>User</th>
                <th>Comment</th>
                <th>Evaluations</th>
            </tr>
            </thead>
            <tbody>
            {% for submission in object_list %}
                <tr>
                    <td data-order="{{ submission.created|date:"U" }}">{{ submission.created }}</td>
                    <td>{{ submission.phase.title }}</td>
                    <td>
                        {{ submission.creator|user_profile_link }}
                    </td>
                    <td>{{ submission.comment }}</td>
                    <td>
                        {% for evaluation in submission.evaluation_set.all %}
                            <span class="badge
                                {% if evaluation.status == evaluation.FAILURE or evaluation.status == evaluation.CANCELLED %}
                                    badge-danger
                                {% elif evaluation.status == evaluation.RETRY %}
                                    badge-warning
                                {% elif evaluation.status == evaluation.SUCCESS %}
                                    badge-success
                                {% else %}
                                    badge-info
                                {% endif %}">
                                {{ evaluation.get_status_display }}
                            </span>
                            {% if evaluation.status == evaluation.SUCCESS %}
                                {% if evaluation.published %}
                                    <a href="{{ evaluation.get_absolute_url }}">Result</a>
                                {% else %}
                                    Evaluation is under review by the challenge admins.
                                {% endif %}
                            {% elif evaluation.FAILURE %}
                                {% firstof evaluation.error_message evaluation.get_status_display %}
                            {% endif %}
                        {% endfor %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block script %}
    {{ block.super }}
    <script type="text/javascript">
        $(document).ready(function () {
            $('#submissionsTable').DataTable(
                {
                    order: [[0, "desc"]]
                }
            );
        });
    </script>
{% endblock %}
