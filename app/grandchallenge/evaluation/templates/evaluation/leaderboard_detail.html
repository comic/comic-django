{% extends "challenge.html" %}
{% load url %}

{% block title %}Leaderboard - {{ block.super }}{% endblock %}

{% block breadcrumbs %}
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a
                href="{% url 'challenges:list' %}">Challenges</a>
        </li>
        <li class="breadcrumb-item"><a
                href="{{ challenge.get_absolute_url }}">{% firstof challenge.title challenge.short_name %}</a></li>
        <li class="breadcrumb-item active">
            {{ phase.title }} Leaderboard
        </li>
    </ol>
{% endblock %}

{% block content %}
    <h2>{{ phase.title }} Leaderboard {{ request.GET.leaderboardDate }}</h2>

    <div class="table-responsive mb-3">
        <table class="table table-hover table-borderless table-sm"
               id="resultsTable">
            <thead class="thead-light">
            <tr>
                <th> <input type="checkbox" id="generalCheck"></th>
                {% for column in columns %}
                    <th {% if column.toggleable %}class="toggleable"{% endif %}>{{ column.title }}</th>
                {% endfor %}
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    {% if phase.result_display_choice == phase.BEST %}
        <p class="small ml-3">
            Only the best published result for each participant is listed.
        </p>
    {% elif phase.result_display_choice == phase.MOST_RECENT %}
        <p class="small ml-3">
            Only the most recent published result for each participant is listed.
        </p>
    {% else %}
        <h3>Historical Leaderboard</h3>
        <form class="form-inline" action="">
            <label class="mr-sm-2" for="leaderboardDate">View the leaderboard from this date:</label>
            <input class="mr-sm-2" type="date" id="leaderboardDate" name="leaderboardDate" required
                   value="{{ request.GET.leaderboardDate }}">
            <button type="submit" class="btn btn-primary btn-sm">Submit</button>
        </form>
    {% endif %}

    {% if "change_challenge" in challenge_perms %}
        <h3>Export Leaderboard</h3>
        {% for offset in offsets %}
            <p>
                <a class="btn btn-primary"
                   href="{% url 'api:evaluation-list' %}?format=csv&submission__phase={{ phase.pk }}&offset={{ offset }}&limit={{ limit }}"
                   download="{{ phase.challenge.short_name }}_{{ phase.slug }}_evaluations_{{ offset|add:1 }}_{{ offset|add:limit }}_{{ now }}">
                    <i class="fas fa-file-csv"></i> Evaluations ({{ offset|add:1 }} to {{ offset|add:limit }})
                </a>
            </p>
        {% endfor %}
    {% endif %}

    {% if phase.list_view_observable_url %}
        <button type="button" onclick="updateCompareIframe()" class="btn btn-primary" data-toggle="modal" data-target="#compareModal">
            Compare Results
        </button>

        <div class="modal fade" id="compareModal" tabindex="-1" role="dialog" aria-labelledby="compareModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="compareModalLabel">Compare Results</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <iframe id="observableNotebook"
                                class="w-100"
                                height="600px"
                                sandbox="allow-scripts">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

{% endblock %}

{% block script %}
    {{ block.super }}

    <script type="text/javascript">
        $(document).ready(function () {

            var table = $('#resultsTable').DataTable({
                // The column index of the default sort, must match the table set up.
                order: [[1, "asc"]],
                lengthChange: false,
                pageLength: 100,
                serverSide: true,
                ajax: {
                    url: "",
                },
                columnDefs: [
                    {
                        "targets": [0],
                        searchable: false,
                        orderable: false,
                        visible: true
                    },
                    {
                        {%  if phase.show_supplementary_file_link %}
                            "targets": [-1],
                        {% endif %}
                        searchable: false,
                        orderable: false,
                        visible: true
                    }
                    {% if phase.extra_results_columns|length > 0 or phase.scoring_method_choice != phase.ABSOLUTE %}
                        ,{
                        targets: 'toggleable',
                        visible: false,
                    }
                    {% endif %}
                ],
                ordering: true,
                autoWidth: false,
                {% comment %}
                    Default dom-setting copied from here: https://datatables.net/reference/option/dom
                {% endcomment %}
                {% if phase.extra_results_columns|length > 0 or phase.scoring_method_choice != phase.ABSOLUTE %}
                    dom: "<'row'<'col-md-5'l><'col-md-7'f>>" +
                        "<'row'<'col-12'Btr>>" +
                        "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
                    buttons: [
                        {
                            extend: 'colvis',
                            text: 'Additional metrics',
                            columns: '.toggleable'
                        },
                        {
                            text: 'Show all metrics',
                            action: function (e, dt, node, config) {
                                if ($(node).hasClass('metrics-hidden')) {
                                    dt.columns('.toggleable').visible(false);
                                    $(node).removeClass('metrics-hidden');
                                    $(node).text('Show all metrics');
                                } else {
                                    dt.columns('.toggleable').visible(true);
                                    $(node).addClass('metrics-hidden');
                                    $(node).text('Hide additional metrics');
                                }
                            }
                        },
                        {
                            text: 'Compare results',
                            action: function (e, dt, node, config) {
                                // TODO add the action for the comparison
                                console.log('ðŸŽ¹', Object.keys(JSON.parse(localStorage.getItem('compareResults'))));
                            }
                        },
                    ],
                {% endif %}
                scrollX: true
            });

            $('#resultsTable').on('column-visibility.dt', function (e, settings, column, state) {
                var button = table.button(1).node();
                visibility_columns = table.columns('.toggleable').visible();
                var not_all_visible = false;
                visibility_columns.each(function (value) {
                    if (value === false) {
                        not_all_visible = true;
                        return false;
                    }
                });
                if (!not_all_visible) {
                    button.addClass('metrics-hidden');
                    button.text('Hide additional metrics');
                } else {
                    button.removeClass('metrics-hidden');
                    button.text('Show all metrics');
                }
            });

            // Todo general checkbox
            $("input#generalCheck").change(function(){
                console.log('ðŸŽ¹', this.value);
            })

            // Clean results
            localStorage.removeItem('compareResults')
            $('button:contains("Compare results")').addClass('disabled')

            // On click on the table
            $("#resultsTable").on('click', function(e){
                if($(e.target).is(':checkbox')){

                    // Get the existing data from localstorage or create {}
                    var existing = JSON.parse(localStorage.getItem('compareResults')) || {};
                    var resultId = $(e.target).val()
                    var compareResultsButton = $('button:contains("Compare results")')
                    var generalCheckbox = $('#generalCheck')

                    // Add or remove data to the object
                    if($(e.target).is(':checked')){
                        existing[resultId] = true
                        compareResultsButton.removeClass('disabled')
                        generalCheckbox.prop('indeterminate', true)
                    }
                    else {
                        delete existing[resultId];
                    }
                    // Remove indeterminate
                    if (Object.entries(existing).length === 0){
                        generalCheckbox.prop('indeterminate', false)
                        compareResultsButton.addClass('disabled')
                    }

                    // Save current state to localStorage
                    localStorage.setItem('compareResults', JSON.stringify(existing));
                }
            })
        });
        $(window).resize(function () {
            $('#resultsTable').DataTable().columns.adjust()
        });

        function updateCompareIframe() {
            var pks = ["9de37cf7-9e02-45f2-bc95-874a6c5dd6d3", "fa785ae7-26a1-4cc1-8a18-97b2031bfbc5"];
            var search = new URLSearchParams(pks.map(pk => ["pk", pk]))
            document.getElementById('observableNotebook').src = "{% url 'evaluation:observable-detail' challenge_short_name=challenge.short_name slug=phase.slug %}?" + search.toString();
        }
    </script>
{% endblock %}

