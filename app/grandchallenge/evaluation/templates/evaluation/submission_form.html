{% extends "challenge.html" %}
{% load crispy_forms_tags %}
{% load url %}
{% load guardian_tags %}
{% load bleach %}

{% block breadcrumbs %}
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a
                href="{% url 'challenges:list' %}">Challenges</a>
        </li>
        <li class="breadcrumb-item"><a
                href="{{ challenge.get_absolute_url }}">{% firstof challenge.title challenge.short_name %}</a></li>
        <li class="breadcrumb-item">
            <a href="{% url 'evaluation:submission-list' challenge_short_name=challenge.short_name %}">Submissions</a>
        </li>
        <li class="breadcrumb-item active"
            aria-current="page">Create
        </li>
    </ol>
{% endblock %}

{% block sidebar %}
    <div class="nav nav-pills d-none {% if challenge.phase_set.count > 4 %}d-lg-inline-flex{% elif challenge.phase_set.count == 4 %}d-md-inline-flex{% else %}d-sm-inline-flex{% endif %} col-12 pl-3 mb-3">
        {% if "change_challenge" in challenge_perms or user_is_participant %}
            {% for phase in challenge.phase_set.all %}
                <li class="nav-item">
                    <a class="nav-link mr-1 px-4 py-1 {% if request.resolver_match.view_name == 'evaluation:submission-create' and request.resolver_match.kwargs.slug == phase.slug or request.resolver_match.view_name == 'evaluation:submission-create-legacy' and request.resolver_match.kwargs.slug == phase.slug%}active{% endif %}"
                       href="{% url 'evaluation:submission-create' challenge_short_name=challenge.short_name slug=phase.slug %}">{{ phase.title }}</a>
                </li>
            {% endfor %}
            <li>
                <a class="nav-link mr-1 px-4 py-1 {% if request.resolver_match.view_name == 'evaluation:submission-list' %}active{% endif %}"
                    href="{% url 'evaluation:submission-list' challenge_short_name=challenge.short_name %}">Your Submissions
                </a>
            </li>
        {% endif %}
    </div>
    <div class="nav nav-pills d-flex {% if challenge.phase_set.count > 4 %}d-lg-none{% elif challenge.phase_set.count == 4 %}d-md-none{% else %}d-sm-none{% endif %} col-12 pl-3 mb-3">
        {% if "change_challenge" in challenge_perms or user_is_participant %}
            <div class="btn dropdown border-0 px-0 py-0 mb-1">
                <a class="btn btn-outline-dark dropdown-toggle phaseButton mr-1 px-4"
                   data-toggle="dropdown"
                   href="#"
                   role="button"
                   aria-expanded="false">
                    Choose a Phase</a>
                <div class="dropdown-menu dropdown-menu-left" role="menu">
                    {% for phase in challenge.phase_set.all %}
                        <li class="dropdown-item challengeDropdown px-0 py-0">
                            <a class="nav-link mr-1 px-4 py-1"
                           href="{% url 'evaluation:submission-create' challenge_short_name=challenge.short_name slug=phase.slug %}"
                            style="color: black">{{ phase.title }}</a>
                        </li>
                    {% endfor %}
                </div>
            </div>
            <li>
                <a class="nav-link mr-1 px-4 py-1 {% if request.resolver_match.view_name == 'evaluation:submission-list' %}active{% endif %}"
                   href="{% url 'evaluation:submission-list' challenge_short_name=challenge.short_name %}">Your Submissions
                </a>
            </li>
        {% endif %}
    </div>
{% endblock %}

{% block content %}
    <h2>{{ phase.title }} Submission</h2>

    {{ phase.submission_page_html|clean }}

    <h3>Create a new submission</h3>

    {% if "change_challenge" in challenge_perms %}

        {% if request.resolver_match.view_name != "evaluation:submission-create-legacy" %}

            <p>
                As an admin for this challenge you can make as many submissions as
                you like. Challenge participants will be allowed to make
                {{ phase.daily_submission_limit }}
                submission{{ phase.daily_submission_limit|pluralize }}
                per day to this phase. You can change the Daily Submission Limit in <a
                    href="{% url 'evaluation:phase-update' challenge_short_name=challenge.short_name slug=phase.slug %}">
                Phase Settings</a>. Please use
                <a href="{% url 'evaluation:submission-create-legacy' challenge_short_name=challenge.short_name slug=phase.slug %}">
                    this form</a>
                if you would like to create a submission on the behalf of one of the participants of this challenge.
            </p>

        {% endif %}

        {% crispy form %}

    {% else %}

        {% if pending_evaluations %}

            <p>
                You need to wait until all of your existing submissions have
                been evaluated before you can make another submission.
                <a href="{% url 'evaluation:submission-list' challenge_short_name=challenge.short_name %}">
                    Click here
                </a>
                to see their status.
            </p>

        {% elif phase.daily_submission_limit == 0 %}

            <p>Submissions are closed for this phase.</p>

        {% elif remaining_submissions <= 0 %}

            <p>
                You have reached your submission limit for today. You can make
                another submission in {{ next_submission_at|timeuntil }}.</p>

        {% else %}

            <p>
                You can make {{ remaining_submissions }} more
                submission{{ remaining_submissions|pluralize }} today.
            </p>

            {% crispy form %}

        {% endif %}

    {% endif %}
{% endblock %}
