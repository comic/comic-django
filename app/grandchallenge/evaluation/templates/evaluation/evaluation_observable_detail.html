{% extends "base.html" %}
{% load url %}
{% load profiles %}
{% load evaluation_extras %}

{% block breadcrumbs %}
{% endblock %}

{% block footer %}
{% endblock %}

{% block body %}
    <div id="observablehq"></div>

    {% for cell in observable_cells %}
        <div id="{{ cell|cut:" "}}"></div>
    {% endfor %}
{% endblock %}

{% block script %}
    {{ block.super }}

    {{ metrics|json_script:"metrics" }}
    {{ observable_cells|json_script:"cells" }}

    <script type="module">
        import {Runtime, Inspector} from "https://cdn.jsdelivr.net/npm/@observablehq/runtime@4/dist/runtime.js";
        {# TODO: templating this doesn't seem right #}
        import define from "{{ observable_js_definition }}";

        if (window.self !== window.top) {
            const selectedCells = JSON.parse(document.getElementById("cells").textContent)
            const observable = document.querySelector("#observablehq")
            const runtime = new Runtime()
            const main = runtime.module(define,(name) =>{
                const selected = selectedCells.indexOf(name)
                if(selected > -1) {
                    const cellToRender = document.createElement('div')
                    const id = selectedCells[selected].replace(/\s/g,'')  // remove spaces from cell names
                    return new Inspector(document.querySelector('#'+id))
                }
            } );
            main.redefine("parse_results", JSON.parse(document.getElementById("metrics").textContent))
            
        }
    </script>
{% endblock %}
